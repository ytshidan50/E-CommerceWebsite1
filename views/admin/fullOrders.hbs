<section class="mt-4">
  <div class="container-fluid">

    <!-- Header -->
    <div class="row mb-4">
      <div class="col-12 d-flex justify-content-between align-items-center">
        <h2>All Orders Management</h2>
        <div>
          <button class="btn btn-outline-primary btn-sm" onclick="location.reload()">
            <i class="fas fa-sync-alt"></i> Refresh
          </button>
          <button class="btn btn-success btn-sm">
            <i class="fas fa-download"></i> Export
          </button>
        </div>
      </div>
    </div>

    <!-- Stats Row (Adaptive Theme) -->
    <div class="row g-3 mb-4 justify-content-center">
      {{!-- Use bg-body-secondary for primary stat cards --}}
      <div class="col-xs-6 col-sm-4 col-md-2">
        <div class="card bg-body-secondary text-body text-center shadow-sm">
          <div class="card-body">
            <h3>{{orders.length}}</h3>
            <p class="mb-0">Total Orders</p>
          </div>
        </div>
      </div>
      {{!-- Use subtle contextual backgrounds --}}
      <div class="col-xs-6 col-sm-4 col-md-2">
        <div class="card bg-warning-subtle text-warning-emphasis text-center shadow-sm">
          <div class="card-body">
            <h3 id="pendingCount">0</h3>
            <p class="mb-0">Pending</p>
          </div>
        </div>
      </div>
      <div class="col-xs-6 col-sm-4 col-md-2">
        <div class="card bg-primary-subtle text-primary-emphasis text-center shadow-sm">
          <div class="card-body">
            <h3 id="placedCount">0</h3>
            <p class="mb-0">Placed</p>
          </div>
        </div>
      </div>
      <div class="col-xs-6 col-sm-4 col-md-2">
        <div class="card bg-success-subtle text-success-emphasis text-center shadow-sm">
          <div class="card-body">
            <h3 id="deliveredCount">0</h3>
            <p class="mb-0">Delivered</p>
          </div>
        </div>
      </div>
      <div class="col-xs-6 col-sm-4 col-md-2">
        <div class="card bg-danger-subtle text-danger-emphasis text-center shadow-sm">
          <div class="card-body">
            <h3 id="returnedCount">0</h3>
            <p class="mb-0">Returned</p>
          </div>
        </div>
      </div>
      <div class="col-xs-12 col-sm-4 col-md-2">
        <div class="card bg-info-subtle text-info-emphasis text-center shadow-sm">
          <div class="card-body">
            <h3 id="totalRevenue">₹0</h3>
            <p class="mb-0">Revenue</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Orders Table -->
    {{#if (gte orders.length 1)}}

    <div class="card bg-body-secondary text-body">
      <div class="card-body table-responsive">
        <table class="table table-hover align-middle datatable">
          <thead class="table-body-tertiary text-body-secondary">
            <tr>
              <th>#</th>
              <th style="width: 60px; max-width: 60px;">Order ID</th>
              <th>Customer</th>
              <th>Items</th>
              <th>Amount</th>
              <th>Payment</th>
              <th>Status</th>
              <th>Date</th>
              <th>Next Action</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {{#each orders}}
            <tr data-status="{{this.status}}">
              <td>{{add @index 1}}</td>
              <td style="width: 80px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                <input type="text" value="{{toString this._id}}" class="form-control form-control-sm"
                  style="all: unset; width:5em; cursor:text; text-overflow:ellipsis; white-space:nowrap; overflow:hidden; color:magenta"
                  title="{{toString this._id}}" onclick="this.select();" readonly>
              </td>
              <td>
                <strong>{{this.deliveryDetails.mobile}}</strong><br>
                <small class="text-body-secondary">{{this.deliveryDetails.address}}</small>
              </td>
              <td><span class="badge bg-secondary-subtle text-secondary-emphasis">{{this.totalItems}} items</span></td>
              <td><strong class="text-success-emphasis">₹{{this.total}}</strong></td>
              <td>
                {{#if (cond this.payment.method '===' 'COD')}}
                <span class="badge bg-warning-subtle text-warning-emphasis">COD</span>
                {{else}}
                <span class="badge bg-info-subtle text-info-emphasis">Online</span>
                {{/if}}
              </td>
              <td>
                <span class="badge
                  {{#if (cond this.status '===' 'pending')}} bg-warning-subtle text-warning-emphasis{{/if}}
                  {{#if (cond this.status '===' 'placed')}} bg-primary-subtle text-primary-emphasis{{/if}}
                  {{#if (cond this.status '===' 'shipped')}} bg-info-subtle text-info-emphasis{{/if}}
                  {{#if (cond this.status '===' 'delivered')}} bg-success-subtle text-success-emphasis{{/if}}
                  {{#if (cond this.status '===' 'returned')}} bg-danger-subtle text-danger-emphasis{{/if}}
                  {{#if (cond this.status '===' 'cancelled')}} bg-dark-subtle text-dark-emphasis{{/if}}">
                  {{this.status}}
                </span>
              </td>
              <td><small>{{formatDate this.times.ordered}}</small></td>
              <td>
                {{#if (cond this.status '===' 'placed')}}
                <button class="btn btn-sm btn-primary" id="shipOrderBtn-{{this._id}}"
                  onclick="shipOrder('{{this._id}}')">Ship Order</button>
                {{else if (cond this.status '===' 'pending')}}
                <button class="btn btn-sm btn-primary" disabled>Ship Order</button>
                {{else if (cond this.status '===' 'shipped')}}
                <button class="btn btn-sm btn-success" id="confirmDeliveredBtn-{{this._id}}"
                  onclick="confirmDelivered('{{this._id}}')">Mark Delivered</button>
                {{else if (cond this.status '===' 'delivered')}}
                <button class="btn btn-sm btn-success" disabled>Delivered</button>
                {{/if}}
              </td>
              <td>
                <div class="btn-group btn-group-sm">
                  <button class="btn btn-outline-primary" onclick="viewOrder('{{this.userId}}','{{this._id}}')">
                    <i class="fas fa-eye"></i>
                  </button>
                  <button class="btn btn-outline-success" onclick="printOrder('{{this._id}}')">
                    <i class="fas fa-print"></i>
                  </button>
                </div>
              </td>
            </tr>
            {{/each}}
          </tbody>
        </table>
      </div>
    </div>
    {{else}}
    <div class="card text-center p-5 bg-body-secondary text-body">
      <i class="fas fa-inbox fa-3x text-body-tertiary mb-3"></i>
      <h5>No Orders Found</h5>
      <p class="text-body-tertiary">{{error}}</p>
    </div>
    {{/if}}

  </div>
</section>

<script src="/javascripts/adminScripts.js"></script>

<script>
  const orders = {{{ json orders }}};

  document.addEventListener('DOMContentLoaded', () => {
    let pending = 0, placed = 0, delivered = 0, returned = 0, revenue = 0;
    orders.forEach(o => {
      if (o.status === 'pending') pending++;
      if (o.status === 'placed') placed++;
      if (o.status === 'delivered') delivered++;
      if (o.status === 'returned') returned++;
      if (o.status !== 'cancelled' && o.status !== 'returned') revenue += o.total;
    });
    document.getElementById('pendingCount').textContent = pending;
    document.getElementById('placedCount').textContent = placed;
    document.getElementById('deliveredCount').textContent = delivered;
    document.getElementById('returnedCount').textContent = returned;
    document.getElementById('totalRevenue').textContent = '₹' + revenue.toLocaleString('en-IN');
  });

  function viewOrder(userId, id) {
    window.location.href = `/admin/order/${userId}/${id}`;
  }
  function printOrder(id) {
    window.open(`/admin/order/${id}/print`, '_blank');
  }
</script>